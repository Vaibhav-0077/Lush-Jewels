<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Lush Jewels</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Georgia', serif; color: #333; }
    .error { border-color: red !important; }
  </style>
</head>
<body class="bg-gray-50" style="font-family: Times, Times New Roman, serif;">

  <!-- ðŸ”¹ Header -->  
  <header
      class="sticky top-0 z-50 shadow-md h-22"
      style="background-color: #f8e8ee;"
      
    >
    <div class="container mx-auto px-6 py-1" style="font-family: Times, Times New Roman, serif;">
      <div class="flex items-center">
        <!-- <div class="text-2xl font-bold text-gray-800 flex-shrink-0">Lush Jewels</div> -->
          <div class="flex items-center h-full flex-shrink-0">
            <a href="/" class="h-full flex items-center">
              <img
                src="/images/lush_jewels_header_logo.png"
                alt="Lush Jewellery Logo"
                class="h-20 w-auto object-contain"
              />
            </a>
          </div>

      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 md:px-6 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8" style="background-color: #f8e8ee;">

    <!-- ================= LEFT SIDE ================= -->
    <section class="lg:col-span-2 space-y-6 order-2 lg:order-1">

      <!-- Contact Info -->
      <div class="bg-white p-4 md:p-6 rounded-lg shadow" style="background-color: #f9f6f7;">
        <h2 class="text-lg md:text-xl font-semibold mb-4">Contact</h2>
        <input id="email" type="text" placeholder="Email or mobile phone number" 
               class="w-full border rounded px-4 py-2 mb-2 text-sm md:text-base" style="background-color: #fcfcfc;" >
        <p id="email-error" class="text-red-500 text-sm hidden">Enter an email or phone number</p>
        <label class="flex items-center gap-2 text-sm text-gray-600 mt-2">
          <input type="checkbox" class="accent-purple-600"> Email me with news and offers
        </label>
      </div>

      <!-- Delivery Address -->
      <div class="bg-white p-4 md:p-6 rounded-lg shadow space-y-3" style="background-color: #f9f6f7;">
        <h2 class="text-lg md:text-xl font-semibold">Delivery</h2>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <input id="fname" placeholder="First Name" class="border rounded px-4 py-2 text-sm md:text-base" style="background-color: #fcfcfc;">
          <input id="lname" placeholder="Last Name" class="border rounded px-4 py-2 text-sm md:text-base" style="background-color: #fcfcfc;">
        </div>
        <input id="address" placeholder="House Number / Area / Locality" class="border rounded px-4 py-2 w-full text-sm md:text-base" style="background-color: #fcfcfc;">
        <input id="landmark" placeholder="Landmark (eg: Near Apollo Hospital)" class="border rounded px-4 py-2 w-full text-sm md:text-base" style="background-color: #fcfcfc;">

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <input id="city" placeholder="City" class="border rounded px-4 py-2 text-sm md:text-base" style="background-color: #fcfcfc;">
          <select id="state" class="border rounded px-4 py-2 text-sm md:text-base" style="background-color: #fcfcfc;">
            <option value="">State</option>
            <option>Maharashtra</option>
            <!-- <option>Delhi</option>
            <option>Karnataka</option> -->
          </select>
          <input id="pin" type="tel" pattern="[0-9]*" inputmode="numeric" maxlength="6"
            placeholder="PIN Code" 
            class="border rounded px-4 py-2 text-sm md:text-base" style="background-color: #fcfcfc;">
        </div>

        <input id="phone" type="tel" pattern="[0-9]*" inputmode="numeric" maxlength="10"
          placeholder="Phone" 
          class="border rounded px-4 py-2 w-full text-sm md:text-base" style="background-color: #fcfcfc;">

        <label class="flex items-center gap-2 text-sm text-gray-600">
          <input type="checkbox" class="accent-purple-600"> Save this information for next time
        </label>
      </div>

        <!-- ======================================ADD A NEW PAYMENT ================================================== -->

              <!-- Payment -->
      <div class="bg-white p-4 md:p-6 rounded-lg shadow space-y-3" style="background-color: #f9f6f7;">
        <h2 class="text-lg md:text-xl font-semibold">Payment</h2>
        <p class="text-gray-500 text-xs md:text-sm">All transactions are secure and encrypted.</p>

        <label class="flex items-center gap-2 border rounded px-4 py-3" style="background-color: #fcfcfc;">
          <input type="radio" name="payment" value="Online" checked class="accent-purple-600">
          <span class="text-sm md:text-base">Cashfree Payments (UPI, Cards, Wallets, NetBanking)</span>
        </label>

        <label class="flex items-center gap-2 border rounded px-4 py-3" style="background-color: #fcfcfc;">
          <input type="radio" name="payment" value="COD" class="accent-purple-600">
          <span class="text-sm md:text-base">Cash on Delivery (COD)</span>
        </label>

      </div>

      <!-- Privacy Policy Agreement -->
      <div class="mt-3 flex items-start gap-3 text-sm text-gray-600" style="font-family: Times, Times New Roman, serif;">
        <input
          id="agreePolicy"
          type="checkbox"
          checked
          class="mt-1 h-4 w-4 accent-purple-600 cursor-pointer"
        />

        <label for="agreePolicy" class="cursor-pointer leading-relaxed">
          I agree to the
          <a href="/privacy-policy" target="_blank" class="text-purple-600 underline hover:text-purple-800">
            Privacy Policy
          </a>,
          <a href="/terms" target="_blank" class="text-purple-600 underline hover:text-purple-800">
            Terms & Conditions
          </a>
          and
          <a href="/refund-policy" target="_blank" class="text-purple-600 underline hover:text-purple-800">
            Refund Policy
          </a>.
        </label>
      </div>



      <!-- ======================================ADD A NEW PAYMENT over================================================== -->

      <button
        id="complete-order"
        disabled
        class="relative w-full mt-4 px-[60px] py-4
              rounded-full
              text-white text-[16px] font-bold tracking-[1px]
              cursor-pointer
              bg-[linear-gradient(135deg,#d9828c_0%,#d9828c_20%,#d9828c_60%,#d9828c_100%)]

              shadow-[inset_0_2px_6px_rgba(255,255,255,0.8),inset_0_-4px_8px_rgba(180,80,90,0.35),0_12px_25px_rgba(215,120,130,0.45)]

              transition-all duration-300 ease-in-out
              hover:-translate-y-0.5
              hover:shadow-[inset_0_2px_6px_rgba(255,255,255,0.9),inset_0_-4px_10px_rgba(180,80,90,0.45),0_16px_30px_rgba(215,120,130,0.6)]

              disabled:opacity-50
              disabled:cursor-not-allowed
              disabled:hover:translate-y-0
              disabled:hover:shadow-none">

        <span class="pointer-events-none absolute inset-[6px] rounded-full border-[3px] border-white/90"></span>
        Complete Order
      </button>


    </section>

    <!-- ================= RIGHT SIDE ================= -->
    <aside class="bg-white p-4 md:p-6 rounded-lg shadow h-fit order-1 lg:order-2" style="background-color: #f9f6f7;">
      <h2 class="text-lg md:text-xl font-semibold mb-4">Your Order</h2>
      <div id="checkout-cart" class="space-y-4 mb-6"></div>

      <div class="border-t pt-4">
        <div class="flex justify-between text-sm mb-2">
          <span>Subtotal</span>
          <span id="subtotal">â‚¹0</span>
        </div>
        <div class="flex justify-between font-bold text-lg">
          <span>Total</span>
          <span id="total">â‚¹0</span>
        </div>
      </div>
    </aside>
    

  </main>

<script>
  // âœ… Detect if this is a single "Buy Now" checkout
  const params = new URLSearchParams(window.location.search);
  const single = params.get("single") === "true";

  let cart = [];
  if (single) {
    // one product directly from query string
    cart = [{
      name: params.get("name"),
      price: params.get("price"),
      img: params.get("img"),
      qty: parseInt(params.get("qty")) || 1
    }];
  } else {
    // normal cart checkout
    cart = JSON.parse(localStorage.getItem("cart")) || [];
  }

  const mainContainer = document.querySelector('main');
  const checkoutContainer = document.getElementById('checkout-cart');
  let subtotal = 0;

  if (cart.length === 0) {
    mainContainer.style.display = 'none';
    let toast = document.createElement('div');
    toast.textContent = 'âš  Your cart is empty!';
    toast.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2
                      z-50 px-6 py-4 rounded-xl shadow-xl text-white text-lg bg-red-600`;
    document.body.appendChild(toast);
  } else {
    // âœ… Render all products
    cart.forEach(item => {
      const price = parseFloat(item.price.replace(/[^0-9.]/g, '')) || 0;
      const qty = item.qty || 1;
      subtotal += price * qty; // âœ… FIX: subtotal now updates properly

      checkoutContainer.innerHTML += `
        <div class="flex items-center justify-between border rounded p-2">
          <img src="${item.img}" class="w-14 h-14 object-cover rounded">
          <div class="flex-1 ml-3">
            <p class="text-sm font-medium">${item.name || item.title}</p>
            <p class="text-xs text-gray-500">Qty: ${qty}</p>
          </div>
          <p class="text-sm font-semibold">â‚¹${(price * qty).toFixed(2)}</p>
        </div>
      `;
    });

    // âœ… Update totals
    document.getElementById('subtotal').textContent = "â‚¹" + subtotal.toFixed(2);
    document.getElementById('total').textContent = "â‚¹" + subtotal.toFixed(2);
  }

  // âœ… Toast
  function showToast(message, type="success") {
    let toast = document.getElementById('toast');
    if (!toast) {
      toast = document.createElement('div');
      toast.id = 'toast';
      document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 
                      z-50 px-6 py-4 rounded-xl shadow-xl text-white text-lg ${
                        type === "error" ? "bg-red-600" : "bg-green-600"
                      }`;
    setTimeout(()=> toast.remove(), 2500);
  }

  // ====================================âœ… Order complete==========================================================
  // Centered toast helper
  function showToast(message, type = "success") {
    let toast = document.getElementById("toast");
    if (!toast) {
      toast = document.createElement("div");
      toast.id = "toast";
      document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 
      z-50 px-6 py-4 rounded-xl shadow-xl text-white text-lg ${
        type === "error" ? "bg-red-600" : "bg-green-600"
      }`;
    setTimeout(() => toast.remove(), 2500);
  }

  // Single-click checkout handler â€” only one POST to /user/checkout
document.addEventListener("DOMContentLoaded", () => {
  const completeBtn = document.getElementById("complete-order");
  if (!completeBtn) return;

  completeBtn.addEventListener("click", async (e) => {
    e.preventDefault();

    try {
      // ðŸ”´ Reset previous highlights
      document.querySelectorAll("input, textarea, select").forEach(el => {
        el.classList.remove("border-red-500");
      });

      // ðŸŸ¢ Validate required fields
      const fields = [
        "email", "fname", "lname", "address",
        "landmark", "city", "state", "pin", "phone"
      ];

      let allFilled = true;
      for (const id of fields) {
        const el = document.getElementById(id);
        if (!el || !el.value.trim()) {
          el.classList.add("border-red-500"); // ðŸ”´ highlight empty fields
          allFilled = false;
        }
      }

      if (!allFilled) {
        showToast("âš  Fill all required fields", "error");
        return;
      }

      // ðŸ“ž Validate phone and PIN
      const phoneEl = document.getElementById("phone");
      const pinEl = document.getElementById("pin");
      const phone = phoneEl.value.trim();
      const pin = pinEl.value.trim();

      let valid = true;

      if (!/^\d{10}$/.test(phone)) {
        phoneEl.classList.add("border-red-500");
        valid = false;
        showToast("âš  Invalid phone number", "error");
      }

      if (!/^\d{6}$/.test(pin)) {
        pinEl.classList.add("border-red-500");
        valid = false;
        showToast("âš  Invalid PIN code", "error");
      }

      if (!valid) return;

      // âœ… Get selected payment method
      const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value || "COD";

      // âœ… Build userInfo
      const userInfo = {
        email: document.getElementById("email").value,
        fname: document.getElementById("fname").value,
        lname: document.getElementById("lname").value,
        phone,
        address: document.getElementById("address").value,
        landmark: document.getElementById("landmark").value,
        city: document.getElementById("city").value,
        state: document.getElementById("state").value,
        pin,
        paymentMethod,
      };

      // ðŸ›’ Check cart/subtotal
      if (typeof cart === "undefined" || !Array.isArray(cart) || cart.length === 0)
        return showToast("âš  Cart is empty", "error");
      if (typeof subtotal === "undefined")
        return showToast("âš  Subtotal not found", "error");

      const totalAmount = parseFloat(subtotal).toFixed(2);

      // ðŸŸ¢ Submit order
      const res = await fetch("/user/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userInfo, items: cart, totalAmount }),
      });

      let data;
      try { data = await res.json(); } catch (err) { data = null; }

      if (res.ok && data && data.success) {
        showToast("âœ… Order placed successfully!");
        setTimeout(() => (window.location.href = "/"), 1500);
      } else {
        const msg = data?.message || `Server error (${res.status})`;
        showToast("âš  " + msg, "error");
      }
    } catch (err) {
      console.error("âŒ Checkout error:", err);
      showToast("âš  Server error. Try again.", "error");
    }
  });
});

const checkbox = document.getElementById("agreePolicy");
  const orderBtn = document.getElementById("complete-order");

  // Enable by default
  orderBtn.disabled = !checkbox.checked;

  checkbox.addEventListener("change", () => {
    orderBtn.disabled = !checkbox.checked;
  });




</script>


</body>
</html>
